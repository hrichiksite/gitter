rs.slaveOk()


var oneMonths = new Date(Date.now() - 86400000 * 30);
var twoMonths = Date.now() - 86400000 * 60;

function createIdForTimestampString(timestamp) {
  var hexSeconds = Math.floor(timestamp/1000).toString(16);

  while(hexSeconds.length < 8) {
    hexSeconds = "0" + hexSeconds;
  }
  return ObjectId(hexSeconds + "0000000000000000");
}

var roomUris = [
  'FreeCodeCamp/FreeCodeCamp',
  'FreeCodeCamp/Help',
  'FreeCodeCamp/HelpJavaScript',
  // 'angular/angular',
  // 'FreeCodeCamp/chinese',
  // 'vuejs/vue',
  // 'FreeCodeCamp/HelpFrontEnd',
  // 'davidfowl/Channels',
  // 'lilcoders/Lilcoders',
  // 'home-assistant/home-assistant',
  // 'TheOdinProject/theodinproject',
  // 'JuliaLang/julia',
  // 'liam4/tlnccuwagnf/AT-fun',
  // 'my-little-house/Lobby',
  // 'iTXTech/Genisys',
  // 'yiisoft/yii2/rus',
  // 'deeplearning4j/deeplearning4j',
  // 'karb0n13/EGSA',
  // 'aurelia/Discuss',
  // 'CubicChunks-dev/Lobby',
  // 'ronstarcool/TeamChannel',
  // 'ethereum/go-ethereum/private',
  // 'razbor-poletov/razbor-poletov.github.com',
  // 'LaravelRUS/chat',
  // 'home-assistant/home-assistant/devs',
  // 'esoui/esoui',
  // 'DrupalRu/drupal.ru',
  // 'vchelaru/FlatRedBall',
  // 'LaravelRUS/offtop',
  // 'deeplearning4j/dev_channel',
  // 'laravel/laravel',
  // 'x64dbg/x64dbg',
  // 'oeed/Silica',
  // 'nim-lang/Nim',
  // 'nightscout/intend-to-bolus',
  // 'syl20bnr/spacemacs',
  // 'Flexget/Flexget',
  // 'ruHaskell/forall',
  // 'amark/gun',
  // 'FreeCodeCamp/admin',
  // 'AdrianLxM/gerLoopSMALLTALK',
  // 'coala/coala',
  // 'translate/house',
  // 'facebook/reason',
  // 'FreeCodeCamp/HelpBackEnd',
  // 'cpluspluscom/public',
  // 'hioa-cs/IncludeOS/developers_private',
  // 'nodejs/node',
  // 'CosmosOS/Cosmos',
  // 'ceylon/dev',
  // 'TheOdinProject/Random',
  // 'neovim/neovim',
  // 'AtomicGameEngine/AtomicGameEngine',
  // 'liam4/Xx_LeeterHax0rzOnG4mes_xX-YT',
  // 'aura-project/aura',
  // 'TheOdinProject/Ruby',
  // 'fcc-hyd/general',
  // 'Reactive-Extensions/RxJS',
  // 'serverless/serverless',
  // 'PrestaShop/General',
  // 'tokio-rs/tokio',
  // 'scala/scala',
  // 'ethcore/parity',
  // 'MoOx/phenomic',
  // 'hbomb79/Titanium',
  // 'dev-ua/Main-Hall',
  // 'Cyberscripters',
  // 'minio/minio',
  // 'crystal-lang/crystal',
  // 'jurgenzz/teambug',
  // 'Bigtalljosh/DisgruntledEmployeesLLC',
  // 'deeplearning4j/skymind-growth',
  // 'dotnet/orleans',
  // 'FreeCodeCamp/CodeReview',
  // 'marzika/Snapprefs',
  // 'minecrafter/voxelwind',
  // 'Nukkit/Nukkit',
  // 'php-ua/symfony',
  // 'angular/angular-cli',
  // 'everylogbot/everylog',
  // 'weexteam/cn',
  // 'arsenalkorea/live160820',
  // 'abperiasamy/Holodeck',
  // 'Microsoft/TypeScript',
  // 'new-xkit/support',
  // 'ManageIQ/manageiq',
  // 'HearthSim/HearthSim',
  // 'akka/dev',
  // 'arcadia-unity/Arcadia',
  // 'gitterHQ/gitter',
  // 'R4stl1n/allianceauth',
  // 'dev-ua/frontend-ua',
  // 'ethereum/security',
  // 'OpenRCT2/OpenRCT2/non-dev',
  // 'alexandred/VoodooI2C',
  // 'nova-framework/framework/novausers',
  // 'Racer500/advancedofftopics',
  // 'ArduPilot/ardupilot',
  // 'jeelabs',
  // 'gitterHQ',
  // 'PFCKrutonium/Windows-10-Login-Background-Changer',
  // 'getgrav/grav',
  // 'TheOdinProject/Moderators',
  // 'FreeCodeCamp/Espanol',
  // 'webdriverio/webdriverio',
  // 'drone/drone',
  // 'ethereum/go-ethereum',
  // 'ruRust/offtopic',
  // 'uWebSockets/uWebSockets',
  // 'jbonnet/WP4',
  // 'TheOdinProject/bot-spam-playground',
  // 'OpenTreeOfLife/public',
  // 'ruRust/general',
  // 'JavaBy/chat',
  // 'TheOdinProject/Rails',
  // 'FormaLibre/Equipe',
  // 'nRF51822-Arduino-Mbed-smart-watch/Lobby',
  // 'bullgit',
  // 'hapijs/hapi',
  // 'arenanet/api-cdi',
  // 'lhorie/mithril.js',
  // 'FreeCodeCamp/CodingJobs',
  // 'cake-build/cake',
  // 'eslint/eslint',
  // 'scala-js/scala-js',
  // 'marko-js/marko',
  // 'drasko/thingsmart',
  // 'akka/akka',
  // 'mosbth/webbprogrammering',
  // 'MISP/MISP',
  // 'ngrx/store',
  // 'CSSS',
  // 'loudnate/LoopKit',
  // 'angular/angular.js',
  // 'demhydraz/LDBC',
  // 'betaflight/members',
  // 'mikolalysenko/regl',
  // 'dummy-team/random',
  // 'w3c/a11ySlackers',
  // 'Colt/TheWebDeveloperBootcamp',
  // 'ceylon/user',
  // 'radio-t/chat',
  // 'Elao/vimeet',
  // 'trueos/Lobby',
  // 'panter/hls-014',
  // 'aurelia',
  // 'ManageIQ/kacerguis-team',
  // 'deeplearning4j/deeplearning4j/earlyadopters',
  // 'Pher0x/TestRoom',
  // 'USGS-WiM/FEV',
  // 'ory-am/hydra',
  // 'CosmosOS/CoreTeam',
  // 'XENON1T/daq-experts',
  // 'MarianNMT/Lobby',
  // 'Dogfalo/materialize',
  // 'bdunne/WAT',
  // 'codegolf/JS-golfing',
  // 'jhipster/generator-jhipster',
  // 'FreeCodeCamp/LetsPair',
  // 'ceylon/ceylon-ide-intellij',
  // 'fable-compiler/Fable',
  // 'hashicorp-nomad/Lobby',
  // 'cyclejs/cyclejs',
  // 'akkadotnet/akka.net',
  // 'RestComm/Restcomm-discuss',
  // 'inasafe/inasafe',
  // 'webpack/webpack',
  // 'cs50/x',
  // 'tableflip',
  // 'evancohen/smart-mirror',
  // 'datproject/discussions',
  // 'LaravelRUS/SleepingOwlAdmin',
  // 'NiclasOlofsson/MiNET',
  // 'typelevel/cats',
  // 'Awingu/QA',
  // 'rus-speaking/android',
  // 'OpenRCT2/OpenRCT2',
  // 'develop/Lobby',
  // 'openzipkin/zipkin',
  // 'snipe/snipe-it',
  // 'dev-ua/reactjs',
  // 'dwyl/emf',
  // 'tatooine-coders/Team',
  // 'osdc/Hackers',
  // 'xonsh/xonsh',
  // 'twjug/jcconf-team',
  // 'coala/coala/offtopic',
  // 'ceylon',
  // 'WatchBeam/developers',
  // 'esp8266/Arduino',
  // 'spring-projects/spring-boot',
  // 'PHPixie/Hotline',
  // 'yamalight/building-products-with-js',
  // 'etherdelta/etherdelta.github.io',
  // 'gocd/tw-private-chat',
  // 'Rogue00/Code-Noobs',
  // 'adelesas/adele',
  // 'chocolatey_au/Lobby',
  // 'openflexo-team',
  // 'Capstone478/Lobby',
  // 'fish-shell/fish-shell',
  // 'yegor256/elegantobjects',
  // 'reactioncommerce/reaction',
  // 'ethereum/solidity',
  // 'ConsenSys/truffle',
  // 'XENON1T/operations',
  // 'cypress-io/cypress',
  // 'galaxy-iuc/iuc',
  // 'ramda/ramda',
  // 'vim-jp/reading-vimrc',
  // 'reactkr/discuss',
  // 'reactrb/chat',
  // 'marionettejs/backbone.marionette',
  // 'gantry/gantry5',
  // 'mpcjanssen/simpletask-android',
  // 'Wojtek-Jerry/SuuportAndDev',
  // 'apache/incubator-airflow',
  // 'resin-io/chat',
  // 'magefree/mage',
  // 'chelu/arpo',
  // 'XENON1T/analysis',
  // 'LoopKit/Loop',
  // 'calabash/calabash0x',
  // 'dru-io/Drupal',
  // 'http4s/http4s',
  // 'backdrop/backdrop-issues',
  // 'ismailsunni/kartoza-indonesia',
  // 'VentureGroup',
  // 'cc-ready/Office_Hours',
  // 'MirzaI/ProgrammingCircle',
  // 'ruRust/gamedev',
  // 'Rochester-NRT/RocAlphaGo',
  // 'cujojs/most',
  // 'spring-cloud/spring-cloud',
  // 'EvilBeaver/oscript-library',
  // 'atk4/atk4',
  // 'fantasyland/fantasy-land',
  // 'USGS-WiM/StreamStats',
  // 'rendmath/custom-devs',
  // 'Mashape/kong',
  // 'effektif',
  // 'PX4/Firmware',
  // 'Java-Study-Group/Lobby',
  // 'jupyter/jupyterlab',
  // 'trailblazer/chat',
  // 'magaliegimenes/knObcn',
  // 'EOL/eol',
  // 'angular-ui/ui-router',
  // 'php-ua/php',
  // 'dev-ua/ember',
  // 'USGS-WiM',
  // 'FreeCodeCamp/YouCanDoThis',
  // 'FreeCodeCamp/HelpDataViz',
  // 'spry-group/TypeNetwork',
  // 'qooxdoo/qooxdoo',
  // 'nette/nette/cs',
  // 'developit/preact',
  // 'betaflight/betaflight',
  // 'aspnet-contrib/AspNet.Security.OpenIdConnect.Server',
  // 'FreeCodeCamp/Contributors',
  // 'Valloric/YouCompleteMe',
  // 'pupil-labs/pupil-team-chat',
  // 'hail-is/hail',
  // 'vaadin/elements-team',
  // 'rgrp/atomatic',
  // 'evothings/evothings-private',
  // 'sant0ro/Yupi',
  // 'ManageIQ/manageiq/providers',
  // 'Awingu/ops_internal',
  // 'vim-jp/vimconf2016',
  // 'vuejs-ru/Discussion',
  // 'MontCode/GeneralChat',
  // 'getquill/quill',
  // 'kcjpop/lol',
  // 'peercast/public',
  // 'coala/coala/maintainers',
  // 'XENON1T/computing',
  // 'claroline/Claro-devs',
  // 'opendevise',
  // 'claroline/exo',
  // 'GreenPix',
  // 'makailol/evm',
  // 'algolia/instantsearch.js',
  // 'spry-group/DailyScrum',
  // 'patchthecode/JTAppleCalendar',
  // 'tbreloff/Plots.jl',
  // 'Club-Seiden',
  // 'alfred-bratterud/Lillestrom_Unikernelklubb_AS',
  // 'Elao/Technical',
  // 'Codewars/codewars.com',
  // 'AvaloniaUI/Avalonia',
  // 'mgeiss/RADAR',
  // 'stampit-org/stampit',
  // 'sbt/sbt',
  // 'SpoonX/Dev',
  // 'frappe/erpnext',
  // 'ManageIQ/manageiq/ui',
  // 'cockroachdb/cockroach',
  // 'wallabag/wallabag',
  // 'CommBank/zbi',
  // 'NetLogo',
  // 'onyx-platform/onyx',
  // 'adonisjs/adonis-framework',
  // 'mobxjs/mobx',
  // 'chocolatey/choco',
  // 'strongloop/loopback',
  // 'red/red',
  // 'Keras-io/Lobby',
  // 'orx/orx',
  // 'gogits/gogs',
  // 'ksis-group/chat',
  // 'IronLanguages/main',
  // 'scoverage/scoverage',
  // 'ethereum/research',
  // 'GalaxyProteomics/Lobby',
  // 'CLCInc',
  // 'nomad-ui/Lobby',
  // 'hail-is/hail-dev',
  // 'jetconf/chat',
  // 'dataHaskell/Lobby',
  // 'meteor/meteor',
  // 'CommBank/dominion',
  // 'OSVR/OSVR-General',
  // 'blititor/Lobby',
  // 'claudiajs/claudia',
  // 'Cockatrice/Cockatrice',
  // 'zogminer/dev',
  // 'aspnet/Home',
  // 'aurelia-ui-toolkits/team',
  // 'ioam/holoviews',
  // 'glFusion/glfusion',
  // 'nova-framework/framework',
  // 'CERNDocumentServer',
  // 'JasperFx/marten',
  // 'dbwebb-se/python',
  // 'geotrellis/geotrellis',
  // 'xilouris/T-NOVA_WP7_Integration',
  // 'ethereum/minercommunitysupport',
  // 'sqlitebrowser/sqlitebrowser',
  // 'sschmid/Entitas-CSharp',
  // 'oe-lite/dev',
  // 'paradix/SkinCitris',
  // 'fgpv-vpgf/Heartbeat',
  // 'typelevel/general',
  // 'buffalobulletin/Pages',
  // 'wolfmp/WolfMP_UE4',
  // 'koajs/koa',
  // 'Bigtalljosh/Cleansing',
  // 'prooph/improoph',
  // 'africanpenguin',
  // 'sz23/React',
  // 'gwtproject/gwt',
  // 'alkallio/vivante-dashboard',
  // 'angular/material2',
  // 'REXSYS/Lobby',
  // 'rubinius/rubinius',
  // 'blititor/Study',
  // 'vergecommunications/verge',
  // 'ManageIQ/manageiq-ui-self_service',
  // 'exiletrade/exiletrade',
  // 'valueflows',
  // 'Leaflet/Leaflet',
  // 'cybergreen-v2/Lobby',
  // 'gitterHQ/devops',
  // 'apacheignite/ignite',
  // 'adaptlearning/adapt_framework',
  // 'gfx-rs/gfx',
  // 'redux-observable/redux-observable',
  // 'mxstbr/react-boilerplate',
  // 'hechoendrupal/DrupalConsole',
  // 'flutter/flutter',
  // 'home-assistant/home-assistant/ops',
  // 'FreeCodeCamp/linux',
  // 'ilovetravel',
  // 'inspirehep/inspire-next',
  // 'nanalan/bolang',
  // 'gisce/abenergia',
  // 'Masterminds/glide',
  // 'Lucas-ech/TLW',
  // 'USGS-WiM/GroundWaterWatch',
  // 'ponkotuy/MyFleetGirls',
  // 'magefree',
  // 'etlegacy',
  // 'suenjedt/THORgossip',
  // 'ikkentim/SampSharp',
  // 'micropython/Lobby',
  // 'MobiDevelop/robovm',
  // 'TheOdinProject/HTML-CSS',
  // 'tokio-rs/rack-rs',
  // 'openai/gym',
  // 'trueos/lumina',
  // 'tidusjar/PlexRequests.Net',
  // 'functional-streams-for-scala/fs2',
  // 'senecajs/seneca',
  // 'ElaoInfra',
  // 'ethereum/ethereumj',
  // 'eslint',
  // 'debezium/dev',
  // 'TheManagers/manage-our-slaves',
  // 'termux/termux',
  // 'Airflow-Developers/Dev',
  // 'hanami/chat',
  // 'hechoendrupal',
  // 'nohponex/vivante-api',
  // 'CommBank/FeatureSphere',
  // 'spirithostchat/Lobby',
  // 'TheOdinProject/Javascript',
  // 'githubteacher/sep-27-developers',
  // 'nodeschool/organizers',
  // 'dry-rb/chat',
  // 'TheOdinProject/Code-Review',
  // 'milessabin/shapeless',
  // 'CommBank/ConveyorSquad',
  // 'denali-js/Lobby',
  // 'ManageIQ/manageiq/support',
  // 'twbs/bootstrap',
  // 'openai/research',
  // 'jenkinsci-ru/public',
  // 'playframework/playframework',
  // 'DigitalGlobe/hoot-ui/Hoot',
  // 'ethereum/welcome',
  // 'gasparnagy/specflow-dev',
  // 'resin-io/etcher',
  // 'spry-group/Cykik',
  // 'ngrx/effects',
  // 'USGS-WiM/Random',
  // 'tpolecat/doobie',
  // 'DevZenRu/live',
  // 'docker/docker',
  // 'MateuszKrol/MANT',
  // 'errbotio/errbot',
  // 'idaholab/moose/framework',
  // 'FreeCodeCamp/CoreTeam',
  // 'new-xkit/XKit',
  // 'MonoGame/MonoGame',
  // 'bokeh/bokeh',
  // 'IdentityServer/IdentityServer4',
  // 'quasarframework/Lobby',
  // 'deeplearning4j/documentation',
  // 'JunoLab/Juno',
  // 'rom-rb/chat',
  // 'rus-speaking/android-rx',
  // 'ESova/program',
  // 'Tanaguru/Team',
  // 'etlegacy/etlegacy',
  // 'Awingu/Engineering',
  // 'dwyl/OxfordAbstracts',
  // 'hioa-cs/IncludeOS',
  // 'Deep-Fried-Code/DeliciousGameDev',
  // 'anderspitman/CSE340',
  // 'nightscout/public',
  // 'gtacs/r-d',
  // 'synrc/n2o',
  // 'survivejs/react',
  // 'akka/reactive-kafka',
  // 'begriffs/postgrest',
  // 'OSSIA/i-score',
  // 'jupyterhub/jupyterhub',
  // 'jamorham/xDrip-plus',
  // 'deeplearning4j/deeplearning4j/tuninghelp',
  // 'angular/angular-2-ionic-2',
  // 'gitterHQ/developers',
  // 'FreeCodeCamp/Calgary',
  // 'lampepfl/dotty',
  // 'LadyViktoria/germanLOOP',
  // 'os-js/OS.js',
  // 'cefsharp/CefSharp',
  // 'PrismarineJS/node-minecraft-protocol',
  // 'Mainflux/mainflux',
  // 'craftworkgames/MonoGame.Extended',
  // 'pokemongoers/B4',
  // 'JavaBy/Kotlin',
  // 'quintelligence/BVAL',
  // 'mavlink/qgroundcontrol',
  // 'quintelligence/BScraping',
  // 'real-logic/Aeron',
  // 'etops/ow-back',
  // 'fonyedjs/Lobby',
  // 'Microsoft/vscode',
  // 'rostlabjs16projecte/Lobby',
  // 'budgie-remix/team',
  // 'rails/rails',
  // 'old-but-so-good/tarasboulba',
  // 'translate/dev',
  // 'Elao/CloudConnect',
  // 'Elao/RareDiseaseDay',
  // 'postcss/postcss',
  // 'PecanProject/pecan',
  // 'OrchardCMS/Orchard',
  // 'codingamigos/chat',
  // 'adaptlearning/multilanguage',
  // 'JuliaML/chat',
  // 'FormidableLabs/victory',
  // 'KotlinBy/Community',
  // 'chocolatey/chocolatey.org',
  // 'FrSky-OS/Beta-feedback/FW-pretest',
  // 'FreeCodeCamp/php',
  // 'opentracing/public',
  // 'Reactive-Extensions/Rx.NET',
  // 'openiddict/openiddict-core',
  // 'jquery/meeting',
  // 'nerves-project',
  // 'scala-android/sbt-android',
  // 'nanoc/nanoc',
  // 'rust-lang/rust',
  // 'EvilBeaver/OneScript',
  // 'ethereum/web3.js',
  // 'mtgjson/mtgjson',
  // 'pitchmen/divers',
  // 'red/help',
  // 'adnotam',
  // 'dpc/slog-rs',
  // 'mozilla-ssh_scan/Lobby',
  // 'MarshallOfSound/Google-Play-Music-Desktop-Player-UNOFFICIAL-',
  // 'openMF/mifos',
  // 'ruHaskell/blah',
  // 'unexpectedjs/unexpected',
  // 'OpenRCT2/team',
  // 'golang-korean-community/Lobby',
  // 'DigitalGlobe/MapEdit',
  // 'Microsoft/malmo',
  // 'rwaldron/johnny-five',
  // 'iceddev/rando',
  // 'gocd/gocd',
  // 'sep-19-developers/Lobby',
  // 'Developer-Universe/Trivia',
  // 'samaaron/sonic-pi',
  // 'infinitered/ignite',
  // 'univote/dev',
  // 'oskarpearson/mmeowlink',
  // 'meanjs/mean',
  // 'Weasyl/weasyl',
  // 'coders-of-fcc/Lobby',
  // 'kriasoft/react-starter-kit',
  // 'ethereum/cpp-ethereum-development',
  // 'torch/torch7',
  // 'adaptlearning/adapt_authoring',
  // 'uikit/uikit',
  // 'SebastianM/angular2-google-maps',
  // 'NetLogo/NetLogo',
  // 'chat-rooms/reactjs',
  // 'pydio/pydio7beta',
  // 'myxit/Lobby',
  // 'reactor/reactor',
  // 'asfh',
  // 'pybee',
  // 'ng-book/ng-book',
  // 'freeablo/Lobby',
  // 'JoernL/LimiTTer',
  // 'ethereum/devcon2social',
  // 'Galaxy-Freiburg/Lobby',
  // 'ethpm/Lobby',
  // 'channelsuite',
  // 'sem-js/study-group',
  // 'VitalElement/AvalonStudio',
  // 'nightscout/dexdrip',
  // 'wizardamigosinstitute/wizardamigo',
  // 'VirtoCommerce/vc-platform',
  // 'LightTable/LightTable',
  // 'ps2/rileylink',
  // 'Awingu/front-end',
  // 'DotNetAnalyzers/WpfAnalyzers',
  // 'spark-jobserver/spark-jobserver',
  // 'ethereum/GPP',
  // 'emadurandal/GLBoost',
  // 'flarum/developers',
  // 'solid/node-solid-server',
  // 'IOT-2K16-JMI/IOT',
  // 'allegro/ralph',
  // 'dev-osrose/osIROSE',
  // 'openai/deeplearning',
  // 'ethereum/mist',
  // 'tgriesser/knex',
  // 'automatic-chainsaw/chainsaw',
  // 'saasbook/MOOC',
  // 'translate/pootle',
  // 'angular/angularfire2',
  // 'tsgit/natter',
  // 'iceddev/veddeci',
  // 'vimberlin/vimfest',
  // 'pelias/pelias',
  // 'GitterJeNejlepsi/TopSecret',
  // 'codingamigos/learners',
  // 'gRally/dev/DevCorner',
  // 'deeplearning4j/bots',
  // 'dbaldwin/DronePan',
  // 'me-no-dev/ESPAsyncWebServer',
  // 'angular/protractor',
  // 'Bart274/HA_icloud',
  // 'Elgg/Elgg',
  // 'cvogt/cbt',
  // 'graphql-java/maintainers',
  // 'monarch-initiative',
  // 'TheOdinProject/Getting-hired',
  // 'Misyjne-pl/prace',
  // 'Immington-Industries/way-cooler',
  // 'MahApps/MahApps.Metro',
  // 'MonoGame/Private',
  // 'tors/ex-pm',
  // 'kartoza/kartoza',
  // '2016-08-aurelia-workshop/post-workshop',
  // 'springjazzy/GIS_JKH_Integration',
  // 'scala/contributors',
  // 'matplotlib/matplotlib',
  // 'static-dev/spike',
  // 'ArduPilot/GeneralChat',
  // 'jspm/jspm',
  // 'ChurchCRM/CRM',
  // 'wf3-marseille/Lobby',
  // 'egoboo/egoboo',
  // 'HuygensING/timbuctoo'
].map(function(x) {
  return x.toLowerCase();
});

var roomIds = db.troupes.find({ lcUri: { $in: roomUris } }).map(function(f) { return f._id });

var a = db.chatmessages.aggregate([{
  $match: {
    _id: { $gt: createIdForTimestampString(twoMonths) },
    toTroupeId: { $in: roomIds },
    sent: { $type: 'date' }
  }
}, {
  $group: {
    _id: {
      userId: '$fromUserId',
      troupeId: '$toTroupeId',
    },
    firstSent: { $min: '$sent'},
    lastSent: { $max: '$sent'},
  },
}, {
  $project: {
    initial: { $cond: [{ $lt: ['$firstSent', oneMonths ] }, true, false ] },
    current: { $cond: [{ $gte: ['$lastSent', oneMonths ] }, true, false ] },
  },
}, {
  $project: {
    type: { $cond: [{ $eq: ['$initial', true ] },
              { $cond: [{ $eq: ['$current', true ] }, 'retained', 'lost' ]},
              { $cond: [{ $eq: ['$current', true ] }, 'new', 'impossible' ]},
            ]
          }
  },
}, {
  $group: {
    _id: {
      troupeId: '$_id.troupeId',
      type: '$type',
    },
    count: {
      $sum: 1
    }
  },
}, {
  $group: {
    _id: '$_id.troupeId',
    v: {
      $addToSet: {
        type: '$_id.type',
        count: '$count'
      }
    },
  },
// }, {
//   $project: {
//     retained: { $arrayElemAt: [{ $filter: { input: '$v', as: 't', cond: { $eq: ['$$t.type', 'retained'] } } }, 0] },
//     lost: { $arrayElemAt: [{ $filter: { input: '$v', as: 't', cond: { $eq: ['$$t.type', 'lost'] } } }, 0] },
//     new: { $arrayElemAt: [{ $filter: { input: '$v', as: 't', cond: { $eq: ['$$t.type', 'new'] } } }, 0] },
//   },
// }, {
//   $project: {
//     retained: { $ifNull: ['$retained.count', 0] },
//     lost: { $ifNull: ['$lost.count', 0] },
//     new: { $ifNull: ['$new.count', 0] },
//   },
// }, {
//   $project: {
//     retained: 1,
//     lost: 1,
//     new: 1,
//     total: { $add: ['$retained', '$lost', '$new'] },
//     retentionRate: { $divide: ['$retained', { $add: ['$retained', '$lost', '$new'] }]}
//   },
// }, {
//   $lookup: {
//     from: "troupes",
//     localField: "_id",
//     foreignField: "_id",
//     as: "troupe"
//   },
// }, {
//   $unwind: "$troupe"
// }, {
//   $project: {
//     _id: 1,
//     uri: '$troupe.uri',
//     retained: 1,
//     lost: 1,
//     new: 1,
//     total: 1,
//     retentionRate: 1
//   },
}]);

printjson(a);
// print('uri,retained,lost,new,total,retentionRate')
// a.forEach(function(i) {
//   print([
//     i.uri,
//     i.retained,
//     i.lost,
//     i.new,
//     i.total,
//     i.retentionRate
//   ].join(','))
// })
